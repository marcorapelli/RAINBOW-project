<!DOCTYPE html>

<!-- This file contains the html file.
  -- It can be invoked from any browser tab, with http://serverfull.polito.it:6006 link or https://serverfull.polito.it:7007 link.
  -- The html file loads all the libraries (mapbox, socketIO, etc.) and all the data required for page visualization.
  -- After defining the main page visualization, it calls the client.js (CityAggregator.js) for the dinamic visualization part.
-->

<html lang="en" dir="ltr">
	<head>
		<meta charset="utf-8">
		<title>Rainbow Project</title>

		<!-- Various methods for SocketIO library upload. **BEWARE! This choice may cause serval errors!!** -->
		<!-- CDN SocketIO upload. It works for remote library upload when the URL ask for html file -->
		<!-- <script src="https://cdn.socket.io/4.1.1/socket.io.js"></script> -->

		<!-- Virtual path with remote address SocketIO upload. For remote library upload when the URL ask for html file, but doesn't work -->
		<!--<script src="https://serverfull.polito.it:6006/socket.io/socket.io.js"></script> -->
		<!-- Virtual path for SocketIO upload. It works for local library upload when the URL ask for a connection through a port -->
		<script type="text/javascript" src="/socket.io/socket.io.js"></script>


		<!-- Mapbox libraries remote upload -->
		<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
		<script src="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js"></script>
		<link href="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css" rel="stylesheet">

		<!-- Other libraries remote upload -->
		<script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
		<script src="https://canvas-gauges.com/download/latest/all/gauge.min.js"></script>
		
		<!-- Traffic data upload -->
        <script src="data/TrafficRed0_1.geojson"></script>
		<script src="data/TrafficOrange0_1.geojson"></script>
		<script src="data/TrafficYellow0_1.geojson"></script>
		<script src="data/TrafficRed1_2.geojson"></script>
		<script src="data/TrafficOrange1_2.geojson"></script>
		<script src="data/TrafficYellow1_2.geojson"></script>
		<script src="data/TrafficRed2_3.geojson"></script>
		<script src="data/TrafficOrange2_3.geojson"></script>
		<script src="data/TrafficYellow2_3.geojson"></script>
		<script src="data/TrafficRed3_4.geojson"></script>
		<script src="data/TrafficOrange3_4.geojson"></script>
		<script src="data/TrafficYellow3_4.geojson"></script>
		<script src="data/TrafficRed4_5.geojson"></script>
		<script src="data/TrafficOrange4_5.geojson"></script>
		<script src="data/TrafficYellow4_5.geojson"></script>
		<script src="data/TrafficRed5_6.geojson"></script>
		<script src="data/TrafficOrange5_6.geojson"></script>
		<script src="data/TrafficYellow5_6.geojson"></script>
		<script src="data/TrafficRed6_7.geojson"></script>
		<script src="data/TrafficOrange6_7.geojson"></script>
		<script src="data/TrafficYellow6_7.geojson"></script>
		<script src="data/TrafficRed7_8.geojson"></script>
		<script src="data/TrafficOrange7_8.geojson"></script>
		<script src="data/TrafficYellow7_8.geojson"></script>
		<script src="data/TrafficRed8_9.geojson"></script>
		<script src="data/TrafficOrange8_9.geojson"></script>
		<script src="data/TrafficYellow8_9.geojson"></script>
		<script src="data/TrafficRed9_10.geojson"></script>
		<script src="data/TrafficOrange9_10.geojson"></script>
		<script src="data/TrafficYellow9_10.geojson"></script>
		<script src="data/TrafficRed10_11.geojson"></script>
		<script src="data/TrafficOrange10_11.geojson"></script>
		<script src="data/TrafficYellow10_11.geojson"></script>
		<script src="data/TrafficRed11_12.geojson"></script>
		<script src="data/TrafficOrange11_12.geojson"></script>
		<script src="data/TrafficYellow11_12.geojson"></script>
		<script src="data/TrafficRed12_13.geojson"></script>
		<script src="data/TrafficOrange12_13.geojson"></script>
		<script src="data/TrafficYellow12_13.geojson"></script>
		<script src="data/TrafficRed13_14.geojson"></script>
		<script src="data/TrafficOrange13_14.geojson"></script>
		<script src="data/TrafficYellow13_14.geojson"></script>
		<script src="data/TrafficRed14_15.geojson"></script>
		<script src="data/TrafficOrange14_15.geojson"></script>
		<script src="data/TrafficYellow14_15.geojson"></script>
		<script src="data/TrafficRed15_16.geojson"></script>
		<script src="data/TrafficOrange15_16.geojson"></script>
		<script src="data/TrafficYellow15_16.geojson"></script>
		<script src="data/TrafficRed16_17.geojson"></script>
		<script src="data/TrafficOrange16_17.geojson"></script>
		<script src="data/TrafficYellow16_17.geojson"></script>
		<script src="data/TrafficRed17_18.geojson"></script>
		<script src="data/TrafficOrange17_18.geojson"></script>
		<script src="data/TrafficYellow17_18.geojson"></script>
		<script src="data/TrafficRed18_19.geojson"></script>
		<script src="data/TrafficOrange18_19.geojson"></script>
		<script src="data/TrafficYellow18_19.geojson"></script>
		<script src="data/TrafficRed19_20.geojson"></script>
		<script src="data/TrafficOrange19_20.geojson"></script>
		<script src="data/TrafficYellow19_20.geojson"></script>
		<script src="data/TrafficRed20_21.geojson"></script>
		<script src="data/TrafficOrange20_21.geojson"></script>
		<script src="data/TrafficYellow20_21.geojson"></script>
		<script src="data/TrafficRed21_22.geojson"></script>
		<script src="data/TrafficOrange21_22.geojson"></script>
		<script src="data/TrafficYellow21_22.geojson"></script>
		<script src="data/TrafficRed22_23.geojson"></script>
		<script src="data/TrafficOrange22_23.geojson"></script>
		<script src="data/TrafficYellow22_23.geojson"></script>
		<script src="data/TrafficRed23_24.geojson"></script>
		<script src="data/TrafficOrange23_24.geojson"></script>
		<script src="data/TrafficYellow23_24.geojson"></script>

		<!-- Styles and fonts upload for the map -->
		<link rel="stylesheet" type="text/css" href="styles/RainbowStyles.css">
		<link rel="stylesheet" type="text/css" href="styles/fonts/fonts.css">

		<!-- Scripts for clients upload -->
		<script type="text/javascript" src="scripts/SetTraffic.js"></script>
		<script type="text/javascript" src="scripts/GeoNetArea.js"></script>
		<script type="text/javascript" src="scripts/pulsingDot_randomColors.js"></script>
		<script type="text/javascript" src="scripts/CityAggregator.js"></script>	
		
		<!-- Styles and scripts for the loading bar upload (unused) -->
		<link rel="stylesheet" type="text/css" href="styles/loading-bar.css">
	    	<script type="text/javascript" src="scripts/loading-bar.js"></script>
		<!-- Silence the favicon error -->
		<link rel="shortcut icon" href="#">
		
	</head>
	
	
	<body>
		<div id="map"></div>
		
		<script>
		
			//**** Mapbox token. If you want to reuse this material, please remind to generate a new token and put it here. 
			mapboxgl.accessToken = 'pk.eyJ1IjoicmFwZWxsaSIsImEiOiJja29vaXhsNjIwYnk2MnBwaWRyMHVnOXVrIn0.5XltFDvCmLfPMsrOpKm0Yg';
			

			//**** Geojson defining the initial map visualization
    		var map = new mapboxgl.Map({
        		//style: 'mapbox://styles/mapbox/light-v10',
        		style: 'mapbox://styles/rapelli/cjy750ee403ur1cqkoi6qf107',
        		center: [7.683933,45.069106],
        		zoom: 15,
        		pitch: 45,
			//pitch: 0,
        		bearing: 0,
        		container: 'map',
        		arround : [7.683933,45.069106],
        		antialias: true
    		});
    		
    		
    		//**** Geojson defining the initial map center
            var ourcenter = {
            	"type": "FeatureCollection",
                "features": [{
                		"type": "Feature",
                	    "geometry": {
                    		"type": "Point",
                        	"coordinates": [7.683933,45.069106]
                    	}
                }]
            };

			var rsu = {
				"type": "FeatureCollection",
				"features": []
			};

			var vehicle = {
			"type": "geojson",
			"data": {
					"type": "FeatureCollection",
					"features": []
				}
			};
            
            
        	//**** Initializing the zoom and rotation commands
	    	var controls = new mapboxgl.NavigationControl();
	   	 	map.addControl(controls);
	    	map.dragRotate.disable();
	    	map.dragPan.enable(); //Allows to pan the window of the map.


			//**** The 'building' layer in the mapbox-streets vector source contains building-height data from OpenStreetMap.
    		map.on('load', function () {
        	// Insert the layer beneath any symbol layer.
			var points = turf.featureCollection([]); //**** to hold latitude and longitude data points
	   			
        		var layers = map.getStyle().layers;
        		var labelLayerId;
        		for (var i = 0; i < layers.length; i++) {
            		if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
                		labelLayerId = layers[i].id;
                		break;
            		}
        		}


        		//**** Geojson defining the buildings layer
        		map.addLayer(
            		{
                		'id': 'add-3d-buildings',
                		'source': 'composite',
                		'source-layer': 'building',
                		'filter': ['==', 'extrude', 'true'],
                		'type': 'fill-extrusion',
                		'minzoom': 14,
                		'paint': {
                    		'fill-extrusion-color': '#abc',

                    		//**** Use an 'interpolate' expression to add a smooth transition effect to the buildings as the user zooms in
                    		'fill-extrusion-height': [
                        		'interpolate',
                        		['linear'],
                        		['zoom'],
                        		15,
                        		0,
                        		15.05,
                        		['get', 'height']
                    		],
                    		'fill-extrusion-base': [
                        		'interpolate',
                        		['linear'],
                        		['zoom'],
                        		15,
                        		0,
                        		15.05,
                        		['get', 'min_height']
                    		],
                    		'fill-extrusion-opacity': 0.6
                		}
            		},
					labelLayerId
        		);

				//**** Create a void Geojson for the high priority area polygon
				map.addSource("polygon", { 'type': 'geojson', 'data': {
					'type': 'FeatureCollection',
					'features': []
				} });

				//**** Define the area characteristics of the high priority area polygon 
				map.addLayer({
					"id": "polygon-layer",
					"type": "fill",
					"source": "polygon",
					"layout": {},
					"paint": {
						"fill-color": "red",
						"fill-opacity": [
							'case',
							['boolean', ['feature-state', 'hover'], false],
							0.6,
							0.2
						]
					}
				});

				//**** Define the border characteristics of the high/low priority area polygons
				map.addLayer({
					'id': 'polygon-border',
					'type': 'line',
					'source': 'polygon',
					'layout': {},
					'paint': {
						'line-color': '#FF0000',
						'line-width': 2
					}
				});
	
				//**** Hover feature
				/*
				var hoveredStateId = null;
				map.on('mousemove', 'polygon-layer', function (e) {
					if (e.features.length > 0) {
						if (hoveredStateId !== null) {
							map.setFeatureState(
								{ source: 'polygon', id: hoveredStateId },
								{ hover: false }
							);
						}
						hoveredStateId = e.features[0].id;
						map.setFeatureState(
							{ source: 'polygon', id: hoveredStateId },
							{ hover: true }
						);
					}
				}); */
			 
				// When the mouse leaves the state-fill layer, update the feature state of the
				// previously hovered feature.
				/* map.on('mouseleave', 'polygon-layer', function () {
					if (hoveredStateId !== null) {
						map.setFeatureState(
							{ source: 'polygon', id: hoveredStateId },
							{ hover: false }
						);
					}
					hoveredStateId = null;
				});
				*/
        		
				//**** Create an void Geojson for the vehicles
				map.addSource("point", { "type": "geojson", "data": {
					"type": "FeatureCollection",
					"features": []
				} });


				
        		    		
    		
	    		//**** Set the traffic layer
    			SetTraffic(25);        		
        		
        		
        		//**** Start the City Aggregator
        		CityAggregator();

    		});

		
    		
    		
		</script>

	</body>
</html>
